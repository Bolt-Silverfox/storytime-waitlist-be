name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger on either branch
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  
jobs:
  test:
    name: Run Tests
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: |
          pnpm install --no-frozen-lockfile
      
      - name: Run linting
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: Run tests
        run: |
          pip install pytest pytest-asyncio httpx
          pytest -v || echo "No tests found yet"

deploy-staging:
  name: Deploy to Staging
  runs-on: self-hosted
  needs: test
  environment: staging
  if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
  steps:
    - name: Deploy to staging (password-based)
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        APP_DIR: /var/www/storytime-waitlist/backend
      run: |
        set -e

        # Install sshpass (best-effort). Requires sudo on the runner.
        sudo apt-get update || true
        sudo apt-get install -y sshpass || true

        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        # Add server to known_hosts to avoid interactive prompt
        ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

        # Connect using password and run deploy commands on the remote host
        sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" 'bash -s' <<'EOF'
          set -e
          echo "Starting STAGING deployment..."
          cd /var/www/storytime-waitlist/backend

          # Force reset to match remote
          git fetch origin
          git reset --hard origin/staging
          git clean -fd

          # Activate venv and update
          . venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # Run migrations
          alembic stamp 21c4c314e650
          alembic upgrade heads

          # Restart service
          sudo systemctl restart mum-mentor-api-staging
          sudo systemctl status mum-mentor-api-staging --no-pager

          echo "✅ Staging deployment completed successfully!"
        EOF
  deploy-production:
    name: Deploy to Production (Manual)
    runs-on: self-hosted
    needs: test
    # Only allow manual production deploys via workflow_dispatch and require
    # the 'target' input be 'production'. Protect the production environment
    # in GitHub (required reviewers) for extra safety.
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'production'
    environment: production
    steps:
      - name: Deploy to production server (password-based)
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          APP_DIR: /var/www/mum-mentor-be
        run: |
          set -e

          # Install sshpass for password-based authentication (mirrors staging approach)
          # This ensures consistency between staging and production deployments
          sudo apt-get update || true
          sudo apt-get install -y sshpass || true

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Add server to known_hosts to avoid interactive prompt
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          # Connect using password and run deploy commands on the remote host
          # Using sshpass for consistency with staging deployment method
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" 'bash -s' <<'EOF'
            set -e
            echo "Starting PRODUCTION deployment..."
            cd /var/www/mum-mentor-be

            # Force reset to match remote main
            git fetch origin
            git reset --hard origin/main
            git clean -fd

            # Activate venv and update
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # Run migrations
            alembic upgrade heads

            # Restart service
            sudo systemctl restart mum-mentor-api
            sudo systemctl status mum-mentor-api --no-pager

            echo "✅ Production deployment completed successfully!"
          EOF

          # TODO: When SSH key authentication is available, replace sshpass with:
          # ssh -i ~/.ssh/production_key "$SERVER_USER@$SERVER_HOST" 'bash -s' <<'EOF'
          # This will provide better security than password authentication